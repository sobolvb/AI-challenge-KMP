name: AI Code Review

# –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ PR
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    name: AI Code Review

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Call Code Review API
        id: review
        run: |
          # –í—ã–∑–æ–≤ API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ PR
          RESPONSE=$(curl -X POST "${{ secrets.CODE_REVIEW_SERVER_URL }}/api/code-review/analyze" \
            -H "Content-Type: application/json" \
            -d "{\"prNumber\": \"${{ github.event.pull_request.number }}\", \"repository\": \"${{ github.repository }}\"}" \
            -s -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: API returned HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
          echo "$BODY" > review_result.json

      - name: Parse Review Result
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewData = JSON.parse(fs.readFileSync('review_result.json', 'utf8'));

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è PR
            let comment = '## ü§ñ AI Code Review\\n\\n';

            // –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞
            comment += '### üìã –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞\\n';
            comment += reviewData.summary + '\\n\\n';

            // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
            if (reviewData.criticalIssues && reviewData.criticalIssues.length > 0) {
              comment += '### üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã\\n';
              reviewData.criticalIssues.forEach(issue => {
                if (issue.file && issue.line) {
                  comment += `- **${issue.file}:${issue.line}**: ${issue.description}\\n`;
                } else {
                  comment += `- ${issue.description}\\n`;
                }
              });
              comment += '\\n';
            }

            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            if (reviewData.warnings && reviewData.warnings.length > 0) {
              comment += '### ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è\\n';
              reviewData.warnings.forEach(issue => {
                if (issue.file && issue.line) {
                  comment += `- **${issue.file}:${issue.line}**: ${issue.description}\\n`;
                } else {
                  comment += `- ${issue.description}\\n`;
                }
              });
              comment += '\\n';
            }

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if (reviewData.suggestions && reviewData.suggestions.length > 0) {
              comment += '### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\\n';
              reviewData.suggestions.forEach(issue => {
                if (issue.file && issue.line) {
                  comment += `- **${issue.file}:${issue.line}**: ${issue.description}\\n`;
                } else {
                  comment += `- ${issue.description}\\n`;
                }
              });
              comment += '\\n';
            }

            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
            if (reviewData.usedSources && reviewData.usedSources.length > 0) {
              comment += '### üìö –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏\\n';
              reviewData.usedSources.forEach(source => {
                comment += `- \`${source}\`\\n`;
              });
              comment += '\\n';
            }

            comment += '---\\n';
            comment += '_–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–≤—å—é —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ YandexGPT —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RAG –∏ MCP_';

            return comment;

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = ${{ steps.parse.outputs.result }};

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
