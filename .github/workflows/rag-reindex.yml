name: Auto RAG Reindex

# Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€: Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
on:
  push:
    paths:
      - 'project/docs/**/*.md'
    branches:
      - '**'  # Ğ»ÑĞ±Ğ°Ñ Ğ²ĞµÑ‚ĞºĞ°
  workflow_dispatch:  # Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°

jobs:
  reindex-docs:
    runs-on: ubuntu-latest
    name: ĞŸĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ RAG Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check server health
        id: health
        run: |
          echo "ğŸ¥ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ ÑĞµÑ€Ğ²ĞµÑ€Ğ°..."
          HEALTH_RESPONSE=$(curl -X GET "${{ secrets.RAG_SERVER_URL }}/health" \
            -s -w "\n%{http_code}" \
            --connect-timeout 10 \
            --max-time 30)

          HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
          BODY=$(echo "$HEALTH_RESPONSE" | head -n-1)

          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ·Ğ´Ğ¾Ñ€Ğ¾Ğ² (HTTP $HTTP_CODE)"
            echo "health_ok=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²"
          echo "health_ok=true" >> $GITHUB_OUTPUT

      - name: Trigger RAG reindexing
        if: steps.health.outputs.health_ok == 'true'
        id: reindex
        run: |
          echo "ğŸ“š Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸..."

          RESPONSE=$(curl -X POST "${{ secrets.RAG_SERVER_URL }}/api/rag/index/docs" \
            -H "Content-Type: application/json" \
            -s -w "\n%{http_code}" \
            --connect-timeout 30 \
            --max-time 300)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body:"
          echo "$BODY" | jq '.' || echo "$BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸ (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ½Ğ´ĞµĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          INDEXED_COUNT=$(echo "$BODY" | jq '.indexed | length' 2>/dev/null || echo "unknown")

          echo "âœ… ĞŸĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°"
          echo "ğŸ“Š ĞŸÑ€Ğ¾Ğ¸Ğ½Ğ´ĞµĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: $INDEXED_COUNT"
          echo "indexed_count=$INDEXED_COUNT" >> $GITHUB_OUTPUT

          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ ÑˆĞ°Ğ³Ğ°
          echo "$BODY" > reindex_result.json

      - name: Parse and display results
        if: success()
        run: |
          echo "ğŸ“‹ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -f "reindex_result.json" ]; then
            cat reindex_result.json | jq -r '.indexed[] | "  âœ“ \(.sourceId) â†’ \(.chunks) chunks"' || true
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² RAG Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ°!"

      - name: Upload reindex results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rag-reindex-results
          path: reindex_result.json
          retention-days: 7
